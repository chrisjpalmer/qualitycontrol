<html>
    <head>
        <script lang="js">
            window.onload = function() {

                let refreshButton = document.getElementById("refresh")
                let waiting = true;
                let chart1 = document.getElementById("chart-1")
                let chart2 = document.getElementById("chart-2")
                let curChart = chart1
                let nextChart = chart2

               
                

                function loadChart() {
                    waitingChart = nextChart;
                    nextChart.setAttribute("src", `/chart?n=${n}&k=${k}&r=${r}&k2=${k2}&s=${s}&compare=${compare}`)
                }

                function swapCharts() {
                    nextChart.style.visibility = "visible";
                    nextChart.style.height = "1000px"
                    nextChart.style.display = "initial";
                    curChart.style.visibility = "collapse";
                    curChart.style.height = "0px";
                    curChart.style.display = "none";
                    let _n = nextChart
                    let _c = curChart
                    curChart = _n
                    nextChart = _c
                    waitingChart = null
                }

                chart1.addEventListener('load', () => {
                    if (waitingChart != chart1) {
                        return;
                    }
                    swapCharts()
                })

                chart2.addEventListener('load', () => {
                    if (waitingChart != chart2) {
                        return;
                    }
                    swapCharts()
                })


                let n = "1000";
                let k = "30";
                let r = "10";

                let k2 = "30";
                let s = "75";
                let compare = false;

                document.getElementById("n").value = n;
                document.getElementById("k").value = k;
                document.getElementById("r").value = r;

                document.getElementById("k2").value = k2;
                document.getElementById("s").value = s;
                document.getElementById("compare").checked = compare;


                document.getElementById("n").addEventListener('input', (ev) => {
                    n = ev.target.value
                    loadChart()
                })

                document.getElementById("k").addEventListener('input', (ev) => {
                    k = ev.target.value
                    loadChart()
                })

                document.getElementById("r").addEventListener('input', (ev) => {
                    r = ev.target.value
                    loadChart()
                })

                document.getElementById("k2").addEventListener('input', (ev) => {
                    k2 = ev.target.value
                    loadChart()
                })
                document.getElementById("s").addEventListener('input', (ev) => {
                    s = ev.target.value
                    loadChart()
                })

                document.getElementById("compare").addEventListener('input', (ev) => {
                    compare = ev.target.checked
                    loadChart()
                })

                refreshButton.addEventListener('click', () => {
                    loadChart()
                })

                loadChart();
            }
            
        </script>
    </head>
    <body>
        <form>
            <h2>P(m defective in r samples)</h2>
            A factory produces `n` parts in a lot. 
            `k` parts in the lot are defective. A sample `r` is taken
            from the lot and `m` parts in the sample are found to be defective...

            What is the probablity of finding `m` defective parts?
            Or in other words, what is `P(m defective in r samples)`? <br><br>

            <label>n<input id="n" name="n" type="number" min="1" max="1100"></label><br>
            <label>k<input id="k" name="k" type="number" min="1" max="1100"></label><br>
            <label>r<input id="r" name="r" type="number" min="1" max="1100"></label><br>

            The red line shows the true probability distribution, calculated using the formula:

            <i>(n-k C r-m) * (k C m) / (n C r)</i>

            <br><br>
        </form>
        <form>
            <h2>Avg(m defective in r samples over s experiments)</h2>
            <input id="compare" name="compare" type="checkbox"> run <input id="s" name="s" type="number" min="1" max="1100"> experiments with the above values of n, r
            and the following <input id="k2" name="k2" type="number" min="1" max="1100"> k.
            
            The green line shows a distribution gathered by performing the experiments.<br>

            <br>
            <br>

            kl divergence is the difference between the statistically gathered distribution
            (as a result of running s number of experiments and calculating the distribution of M),
            and the true distribution `P(m defective in r samples)`.
            This allows us to see how well running s experiments approximates
            the true distribution on average. 
            
            <br>
            <br>

            When the value of k is the same between the true distrubution and the statistically gathered one, 
            a lower kl divergence means the statistically gathered distribution approxmiates the true distribution. 

            <br>
            <br>
            
            When the value k is not the same between the true distribution and the statistically gathered one,
            a higher value of kl divergence indicates that the statistically gathered distrubution does not approximate the
            true distribution.

            <br>
            <br>
            
            If both these properties are true, then the sample size r and the no. of experiments are working
            together to help us approximate the true distribution from the statistcally gathered one.
            This means we could reliably use this to guess the value of k of the true distribution (if it was an unknown).

            <br>
            <br>

            Try setting k for the experiment to a different value to the true distribution value of k.
            Watch how, by increasing r (the sample size), the kl divergence increases. Then gradually set k to the
            correct value; notice how the kl divergence decreases.
           
        </form>
        <button id="refresh">refresh</button>
        <iframe id="chart-1" style="height:1000px; width: 100%; visibility: visible; display: initial;"></iframe>
        <iframe id="chart-2" style="height:1000px; width: 100%; visibility: collapse; display: none;"></iframe>
    </body>
</html>